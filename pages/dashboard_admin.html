<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Admin - Sistema de Asistencias</title>
  <link rel="stylesheet" href="../css/dashboard.css" />
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    /* Estilos adicionales para el control ESP32 */
    .esp32-controls {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #007bff;
      border: 1px solid #dee2e6;
    }
    /* Estilos para reportes de acceso */
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
}

.status-success {
    background: #d4edda;
    color: #155724;
}

.status-error {
    background: #f8d7da;
    color: #721c24;
}

.table-responsive {
    overflow-x: auto;
}

.summary-cards .card h4 {
    margin: 0 0 5px 0;
    font-size: 14px;
    color: #555;
}

.summary-cards .card p {
    margin: 0;
}

/* Estilos para filtros */
.filters {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.filters label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    font-size: 14px;
}

.filters .form-control {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    min-width: 150px;
}
    .status-box {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      font-weight: bold;
      font-family: monospace;
      background: #e9ecef;
    }

    .status-online {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .status-offline {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    .btn-config {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      font-size: 14px;
    }

    .btn-refresh {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .ip-info {
      margin-top: 10px;
      font-family: monospace;
      background: #e9ecef;
      padding: 8px;
      border-radius: 3px;
      font-size: 14px;
    }

    .control-buttons {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .btn-fingerprint {
      background: #28a745;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-rfid {
      background: #ffc107;
      color: black;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .action-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.btn-fingerprint {
    background: #28a745;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    min-width: 120px;
}

.btn-fingerprint:hover:not(:disabled) {
    background: #218838;
}

.btn-fingerprint:disabled {
    background: #6c757d;
    cursor: not-allowed;
    opacity: 0.7;
}

.btn-rfid {
    background: #ffc107;
    color: black;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    min-width: 100px;
}

.btn-rfid:hover:not(:disabled) {
    background: #e0a800;
}

.btn-rfid:disabled {
    background: #6c757d;
    cursor: not-allowed;
    opacity: 0.7;
}
/* Estilos para reportes de acceso */
.summary-cards {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.summary-cards .card {
    padding: 15px;
    border-radius: 8px;
    min-width: 150px;
    flex: 1;
    text-align: center;
}

.summary-cards .card h4 {
    margin: 0 0 5px 0;
    font-size: 14px;
    color: #555;
}

.summary-cards .card p {
    margin: 0;
    font-size: 24px;
    font-weight: bold;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
    min-width: 80px;
    text-align: center;
}

.status-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.status-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.table-responsive {
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

/* Estilos para filtros */
.filters {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.filters label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    font-size: 14px;
}

.filters .form-control {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    min-width: 150px;
    width: 100%;
}

.filters > div {
    flex: 1;
    min-width: 150px;
}
#accessLogPagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    flex-wrap: wrap;
}

.pagination-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.pagination-btn {
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    min-width: 36px;
    text-align: center;
}

.pagination-btn:hover {
    background: #e9ecef;
}

.pagination-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.pagination-info {
    font-size: 14px;
    color: #666;
}
  </style>
</head>

<body>

  <script src="../js/authGuard.js"></script>

  <div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">Administrador</div>

      <nav>
        <button id="nav-register-employee" class="sidebar-btn">Registrar empleado</button>
        <button id="nav-list-employees" class="sidebar-btn">Lista de empleados</button>
        <button id="nav-schedules" class="sidebar-btn">Horarios</button>
        <button id="nav-attendances" class="sidebar-btn">Asistencias</button>
        <button id="nav-access-reports" class="sidebar-btn">Reportes de Acceso</button>
        <button id="nav-esp32-control" class="sidebar-btn">Control ESP32</button>
      </nav>

      <div style="margin-top:auto;">
        <button id="logoutBtn" class="btn small secondary">Cerrar sesión</button>
      </div>
    </aside>

    <!-- CONTENT -->
    <main class="content">

      <!-- ============= -->
      <!-- REGISTRAR EMPLEADO -->
      <!-- ============= -->
      <section id="section-register-employee" class="pane">
        <h2>Registrar empleado</h2>

        <div class="form">
          <label>Nombre</label>
          <input type="text" id="empName" placeholder="Nombre del empleado">

          <label>Apellido</label>
          <input type="text" id="empLastName" placeholder="Apellido del empleado">

          <label>Nombre de usuario</label>
          <input type="text" id="empUsername" placeholder="Username">

          <label>Contraseña</label>
          <input type="password" id="empPassword" placeholder="Contraseña">

          <label>Género</label>
          <select id="empGenero">
            <option value="">Seleccione</option>
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
          </select>

          <label>Fecha de nacimiento</label>
          <input type="date" id="empDOB">

          <label>Fecha de contrato</label>
          <input type="date" id="empHireDate">

          <label>Área de trabajo</label>
          <input type="text" id="emprea" placeholder="Ej: Cocina, Limpieza">

          <button id="btn-save-employee" class="btn primary" style="margin-top:20px;">
            Registrar empleado
          </button>
        </div>
      </section>

      <!-- ============= -->
      <!-- LISTA DE EMPLEADOS -->
      <!-- ============= -->
      <section id="section-list-employees" class="pane" style="display:none;">
        <h2>Empleados registrados</h2>

        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Nombre</th>
              <th>Apellido</th>
              <th>Rol</th>
              <th>Área</th>
              <th>Huella ID</th>
              <th>RFID</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="employeesTableBody"></tbody>
        </table>
      </section>

      <!-- ============= -->
      <!-- HORARIOS -->
      <!-- ============= -->
      <section id="section-schedules" class="pane" style="display:none;">
        <h2>Horarios</h2>

        <button id="btnOpenCreateSchedule" class="btn primary" style="margin-bottom:15px;">
          Crear horario
        </button>

        <div id="schedulesContainer" class="cards-container"></div>
      </section>
      <section id="section-admin-registration" class="pane" style="display:none;">
  <h2>Registrar mis Credenciales Biométricas</h2>

  <div class="esp32-controls">
    <h3>Información del Administrador</h3>
    <div id="admin-info" style="margin-bottom: 20px;">
      <p><strong>Nombre:</strong> <span id="admin-name">Cargando...</span></p>
      <p><strong>Username:</strong> <span id="admin-username">Cargando...</span></p>
      <p><strong>Huella ID:</strong> <span id="admin-huella">No asignado</span></p>
      <p><strong>RFID:</strong> <span id="admin-rfid">No asignado</span></p>
    </div>

    <div class="control-buttons">
      <button onclick="registerAdminFingerprint()" class="btn-fingerprint" style="padding: 10px 20px;">
        Registrar mi Huella
      </button>
      <button onclick="registerAdminRFID()" class="btn-rfid" style="padding: 10px 20px;">
        Registrar mi RFID
      </button>
    </div>
  </div>
</section>

      <section id="section-admin-attendances" class="pane" style="display:none;">
        <h2>Reporte de Asistencias (Admin)</h2>

        <div class="filters" style="margin-bottom: 15px; display:flex; gap:10px; flex-wrap:wrap;">
          <div>
            <label>Empleado:</label>
            <select id="attendanceUserSelect" class="form-control">
              <option value="">Todos</option>
            </select>
          </div>
          <div>
            <label>Desde:</label>
            <input type="date" id="attendanceStart" class="form-control">
          </div>
          <div>
            <label>Hasta:</label>
            <input type="date" id="attendanceEnd" class="form-control">
          </div>
          <div>
            <label>Área:</label>
            <input type="text" id="attendanceArea" placeholder="Ej: Cocina" class="form-control">
          </div>

          <button id="btnLoadAttendance" class="btn primary">Buscar</button>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th>Empleado</th>
              <th>Área</th>
              <th>Entrada</th>
              <th>Salida</th>
              <th>Duración</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="attendanceTableBody"></tbody>
        </table>
      </section>

<!-- ============= -->
<!-- REPORTES DE ACCESO -->
<!-- ============= -->
<section id="section-access-reports" class="pane" style="display:none;">
  <h2>Reportes de Acceso</h2>

  <div class="filters" style="margin-bottom: 15px; display:flex; gap:10px; flex-wrap:wrap;">
    <div>
      <label>Empleado:</label>
      <select id="accessUserSelect" class="form-control">
        <option value="">Todos los empleados</option>
      </select>
    </div>
    <div>
      <label>Sensor:</label>
      <select id="accessSensorSelect" class="form-control">
        <option value="">Todos</option>
        <option value="Huella">Huella</option>
        <option value="RFID">RFID</option>
        <option value="ZonaSegura">Zona Segura</option>
      </select>
    </div>
    <div>
      <label>Estado:</label>
      <select id="accessStatusSelect" class="form-control">
        <option value="">Todos</option>
        <option value="Permitido">Permitido</option>
        <option value="Denegado">Denegado</option>
      </select>
    </div>
    <div>
      <label>Desde:</label>
      <input type="datetime-local" id="accessStart" class="form-control">
    </div>
    <div>
      <label>Hasta:</label>
      <input type="datetime-local" id="accessEnd" class="form-control">
    </div>
    <div>
      <label>Tipo de Acción:</label>
      <select id="accessActionType" class="form-control">
        <option value="">Todos</option>
        <option value="ENTRADA">ENTRADA</option>
        <option value="SALIDA">SALIDA</option>
        <option value="ACCESO_ZONA_SEGURA">Zona Segura</option>
      </select>
    </div>

    <button id="btnLoadAccessLogs" class="btn primary">Buscar</button>
    <button id="btnExportAccessCSV" class="btn secondary">Exportar CSV</button>
  </div>

  <div class="summary-cards" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
    <div class="card" style="padding: 15px; background: #e7f3ff; border-radius: 8px; min-width: 150px;">
      <h4>Total Accesos</h4>
      <p id="totalAccessCount" style="font-size: 24px; font-weight: bold;">0</p>
    </div>
    <div class="card" style="padding: 15px; background: #d4edda; border-radius: 8px; min-width: 150px;">
      <h4>Permitidos</h4>
      <p id="allowedAccessCount" style="font-size: 24px; font-weight: bold;">0</p>
    </div>
    <div class="card" style="padding: 15px; background: #f8d7da; border-radius: 8px; min-width: 150px;">
      <h4>Denegados</h4>
      <p id="deniedAccessCount" style="font-size: 24px; font-weight: bold;">0</p>
    </div>
    <div class="card" style="padding: 15px; background: #fff3cd; border-radius: 8px; min-width: 150px;">
      <h4>Huellas</h4>
      <p id="fingerprintAccessCount" style="font-size: 24px; font-weight: bold;">0</p>
    </div>
    <div class="card" style="padding: 15px; background: #e2e3e5; border-radius: 8px; min-width: 150px;">
      <h4>RFID</h4>
      <p id="rfidAccessCount" style="font-size: 24px; font-weight: bold;">0</p>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Empleado</th>
          <th>Fecha/Hora</th>
          <th>Sensor</th>
          <th>Estado</th>
          <th>Método</th>
          <th>Tipo</th>
          <th>Motivo</th>
          <th>Detalles</th>
        </tr>
      </thead>
      <tbody id="accessLogTableBody"></tbody>
    </table>
  </div>

  <div id="accessLogPagination" style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">

  </div>
</section>

      <!-- ============= -->
      <!-- CONTROL ESP32 -->
      <!-- ============= -->
      <section id="section-esp32-control" class="pane" style="display:none;">
        <h2> Control del Dispositivo ESP32</h2>

        <div class="esp32-controls">
          <h3>Estado del Sistema</h3>

          <div id="esp32-status" class="status-box status-offline">
            ESP32 DESCONECTADO - Configure la IP primero
          </div>

          <div class="control-buttons">
            <button onclick="configureESP32IP()" class="btn-config">
              Configurar IP ESP32
            </button>

            <button onclick="updateESP32Status()" class="btn-refresh">
              Actualizar Estado
            </button>

            <button onclick="testESP32Connection()" class="btn primary">
              Probar Conexión
            </button>
          </div>

          <div class="ip-info">
            IP Actual: <span id="current-ip">No configurada</span>
          </div>

          <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
            <strong> Instrucciones:</strong>
            <ol style="margin: 10px 0; padding-left: 20px;">
              <li>Anote la IP que aparece en la pantalla del ESP32</li>
              <li>Haga clic en "Configurar IP ESP32" e ingrese la IP</li>
              <li>Verifique que el estado cambie a "CONECTADO"</li>
              <li>Ahora puede registrar huellas desde la lista de empleados</li>
            </ol>
          </div>
        </div>

        <div class="esp32-controls">
          <h3> Información del Dispositivo</h3>
          <div id="esp32-info">
            <p>Esperando conexión...</p>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- ========================= -->
  <!-- MODAL CREAR HORARIO -->
  <!-- ========================= -->
  <div id="createScheduleModal" class="modal" style="display:none;">
    <div class="modal-content">

      <h3>Crear Horario</h3>

      <label>Nombre</label>
      <input id="schName" type="text">

      <label>Días</label>
      <div class="days-grid">
        <label><input type="checkbox" class="sch-day" value="Lun"> Lun</label>
        <label><input type="checkbox" class="sch-day" value="Mar"> Mar</label>
        <label><input type="checkbox" class="sch-day" value="Mie"> Mie</label>
        <label><input type="checkbox" class="sch-day" value="Jue"> Jue</label>
        <label><input type="checkbox" class="sch-day" value="Vie"> Vie</label>
        <label><input type="checkbox" class="sch-day" value="Sab"> Sab</label>
        <label><input type="checkbox" class="sch-day" value="Dom"> Dom</label>
      </div>

      <label>Tipo</label>
      <select id="schTipo">
        <option value="fijo">Fijo</option>
        <option value="rotativo">Rotativo</option>
      </select>

      <label>Hora Entrada</label>
      <input type="time" id="schEntrada">

      <label>Tolerancia Entrada (min)</label>
      <input type="number" id="schTolEnt" value="0">

      <label>Hora Salida</label>
      <input type="time" id="schSalida">

      <label>Tolerancia Salida (min)</label>
      <input type="number" id="schTolSal" value="0">

      <div class="modal-actions">
        <button id="btnSaveSchedule" class="btn primary">Guardar</button>
        <button class="btn secondary" onclick="closeModal('createScheduleModal')">Cancelar</button>
      </div>

    </div>
  </div>

  <!-- ============= -->
  <!-- MODAL EDITAR HORARIO -->
  <!-- ============= -->
  <div id="editScheduleModal" class="modal" style="display:none;">
    <div class="modal-content">

      <h3>Modificar Horario</h3>

      <input type="hidden" id="editScheduleId">

      <label>Nombre</label>
      <input id="editScheduleName" type="text">

      <label>Días</label>
      <div class="days-grid">
        <label><input type="checkbox" class="edit-sch-day" value="Lun"> Lun</label>
        <label><input type="checkbox" class="edit-sch-day" value="Mar"> Mar</label>
        <label><input type="checkbox" class="edit-sch-day" value="Mie"> Mie</label>
        <label><input type="checkbox" class="edit-sch-day" value="Jue"> Jue</label>
        <label><input type="checkbox" class="edit-sch-day" value="Vie"> Vie</label>
        <label><input type="checkbox" class="edit-sch-day" value="Sab"> Sab</label>
        <label><input type="checkbox" class="edit-sch-day" value="Dom"> Dom</label>
      </div>

      <label>Tipo</label>
      <select id="editScheduleTipo">
        <option value="fijo">Fijo</option>
        <option value="rotativo">Rotativo</option>
      </select>

      <label>Hora Entrada</label>
      <input type="time" id="editScheduleEntrada">

      <label>Tolerancia Entrada</label>
      <input type="number" id="editScheduleTolEnt">

      <label>Hora Salida</label>
      <input type="time" id="editScheduleSalida">

      <label>Tolerancia Salida</label>
      <input type="number" id="editScheduleTolSal">

      <div class="modal-actions">
        <button id="btnSaveEditedSchedule" class="btn primary">Guardar cambios</button>
        <button class="btn secondary" onclick="closeModal('editScheduleModal')">Cancelar</button>
      </div>

    </div>
  </div>

  <!-- ========================= -->
  <!-- MODAL ASIGNAR HORARIO -->
  <!-- ========================= -->
  <div id="assignScheduleModal" class="modal" style="display:none;">
    <div class="modal-content">

      <h3>Asignar horario a empleado</h3>

      <input type="hidden" id="assignScheduleId">

      <label>Seleccione empleado</label>
      <select id="assignUserSelect"></select>

      <label>Fecha de inicio</label>
      <input type="date" id="assignStartDate">

      <label>Fecha fin (opcional)</label>
      <input type="date" id="assignEndDate">

      <div class="modal-actions">
        <button id="btnAssignSchedule" class="btn primary">Asignar</button>
        <button class="btn secondary" onclick="closeModal('assignScheduleModal')">Cancelar</button>
      </div>

    </div>
  </div>

  <!-- SOLO CONFIGURACIÓN BÁSICA EN HTML -->
  <script>


    document.addEventListener('DOMContentLoaded', function () {
      // Inicializar navegación ESP32
      const navEsp32 = document.getElementById('nav-esp32-control');
      if (navEsp32) {
        navEsp32.addEventListener('click', function () {
          // showSection está definida en dashboard_admin.js
          if (typeof showSection === 'function') {
            showSection('section-esp32-control');
          }
          // updateESP32Status está definida en dashboard_admin.js  
          if (typeof updateESP32Status === 'function') {
            updateESP32Status();
          }
        });
      }

      // Configurar IP inicial
      const savedIP = localStorage.getItem('esp32_ip');
      if (savedIP) {
        document.getElementById('current-ip').textContent = savedIP;
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="../js/dashboard_admin.js"></script>
</body>

</html>